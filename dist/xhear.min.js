(e=>{function t(e,t){c(this,{type:{enumerable:!0,value:e},keys:{enumerable:!0,value:[]},target:{enumerable:!0,value:t},bubble:{enumerable:!0,writable:!0,value:!0},cancel:{enumerable:!0,writable:!0,value:!1},currentTarget:{enumerable:!0,writable:!0,value:t}})}function r(e,t={}){let r=new Proxy(this,S),s=0;Object.keys(e).forEach(t=>{let n=e[t];/\D/.test(t)||(t=parseInt(t))>=s&&(s=t+1),this[t]=O(n,{parent:r,hostkey:t})});let n={status:"root",length:s,[b]:{},[v]:[],[w]:[],[x]:""};return t.parent&&(n.status="binding",n.parent=t.parent,n.hostkey=t.hostkey),d(this,n),r}const s=()=>Math.random().toString(32).substr(2);let n=Object.prototype.toString;const i=e=>n.call(e).toLowerCase().replace(/(\[object )|(])/g,""),l=e=>void 0===e,a="_proto_"+s(),h="_xevent_"+s();let{defineProperty:o,defineProperties:c,assign:u}=Object;const f=(e,t)=>{if(e===t)return!0;let r=document.createElement("div");return e!==document&&(r.appendChild(e.cloneNode(!1)),!!r.querySelector(t))},d=(e,t)=>{for(let r in t)o(e,r,{writable:!0,value:t[r]})},y=e=>JSON.parse(JSON.stringify(e)),p=((()=>{let e=!1,t=[]})(),e=>{if(!e)return;let t=e._xhearData;t||(t=new q(e),e._xhearData=t);let r=Object.create(t);return c(r,{[a]:{value:t},ele:{enumerable:!0,value:e}}),r=new Proxy(r,M)}),m=e=>{if(e instanceof q)return e;let t,r=i(e);return e instanceof Element?t=p(e):"string"==r?(t=(e=>{let t=document.createElement("div");t.innerHTML=e;return Array.from(t.childNodes).filter(function(e){if(!(e instanceof Text)||e.textContent&&e.textContent.trim())return e})})(e)[0],t=p(t)):"object"==r&&(t=(e=>{if(e.tag&&!(e instanceof q)){let t=document.createElement(e.tag);return e.class&&t.setAttribute("class",e.class),e.text&&(t.textContent=e.text),t}})(e),t=p(t)),t},g="_eves_"+s(),k="_runarrmethod_"+s(),b="_watch_"+s(),v="_synchost_"+s(),w="_modify_"+s(),x="_modify_timer_"+s();let E=e=>e instanceof r;const O=(e,t)=>{let s=e;switch(i(e)){case"object":case"array":s=new r(e,t)}return s},I=(e,t,r,s,n)=>{let l=0;switch(r){case"keyValue":let a=n[e];switch(s){case"=":a==t&&(l=1);break;case":=":E(a)&&a.findIndex(e=>e==t)>-1&&(l=1);break;case"*=":"string"==i(a)&&a.search(t)>-1&&(l=1);break;case"~=":"string"==i(a)&&a.split(" ").findIndex(e=>e==t)>-1&&(l=1)}break;case"hasValue":switch(s){case"=":Object.values(n).findIndex(e=>e==t)>-1&&(l=1);break;case":=":Object.values(n).some(e=>{if(E(e)&&e.findIndex(e=>e==t)>-1)return l=1,!0});break;case"*=":Object.values(n).some(e=>{if("string"==i(e)&&e.search(t)>-1)return l=1,!0});break;case"~=":Object.values(n).some(e=>{if("string"==i(e)&&e.split(" ").findIndex(e=>e==t)>-1)return l=1,!0})}break;case"hasKey":n.hasOwnProperty(e)&&(l=1)}return l},j=(e,t)=>{let r=[],s=t.k,n=t.v,i=t.type,l=t.eqType;return Object.keys(e).forEach(a=>{let h=e[a];if(E(h)){I(s,n,i,l,h)&&r.push(h);let e=j(h,t);r.push(...e)}}),r};let _=(e,t)=>{let r=e[w];r.push(t),clearTimeout(e[x]),e[x]=setTimeout(()=>{r.length=0,r=null},8e3)};c(t.prototype,{trend:{get(){let{modify:e}=this;if(!e)return;let t={genre:e.genre,keys:this.keys};switch(o(t,"oldVal",{value:e.oldVal}),e.genre){case"arrayMethod":let{methodName:r,args:s,modifyId:n}=e;u(t,{methodName:r,args:s,modifyId:n});break;default:let{value:i}=e;E(i)&&(i=i.object),u(t,{key:e.key,value:i})}return t}}});let A=r.prototype={};["concat","every","filter","find","findIndex","forEach","map","slice","some","indexOf","includes"].forEach(e=>{let t=Array.prototype[e];t&&o(A,e,{writable:!0,value(...e){return t.apply(this,e)}})}),["pop","push","reverse","splice","shift","unshift"].forEach(e=>{let r=Array.prototype[e];r&&o(A,e,{writable:!0,value(...n){this[k]=1;let{_entrendModifyId:i}=this;i?delete this._entrendModifyId:(i=s(),_(this,i));let l=r.apply(this,n),a=new t("update",this);return a.modify={genre:"arrayMethod",methodName:e,args:n,modifyId:i},this.emit(a),delete this[k],l}})});const P=(e,t)=>{e[g]||o(e,g,{value:{}});let r=e[g];return r[t]||(r[t]=[])},T=Array.prototype.sort;d(A,{sort(e){this[k]=1;let{_entrendModifyId:r}=this;r?delete this._entrendModifyId:(r=s(),_(this,r));let n;if(e instanceof Array){n=[e];let t=Array.from(this);e.forEach((e,r)=>{this[r]=t[e]})}else{let t=[];n=[t];let r=Array.from(this);T.call(this,e),this.forEach(e=>t.push(r.indexOf(e)))}let i=new t("update",this);return i.modify={genre:"arrayMethod",methodName:"sort",args:n,modifyId:r},this.emit(i),delete this[k],this},on(e,t,r={}){let s=P(this,e),n=r.id;if(!l(n)){let e=s.findIndex(e=>e.eventId==n);e>-1&&s.splice(e,1)}return t&&s.push({callback:t,eventId:r.id,onData:r.data,one:r.one}),this},one(e,t,r={}){return r.one=1,this.on(e,t,r)},off(e,t,r={}){let s=P(this,e);return s.some((e,n)=>{if(e.callback===t&&e.eventId===r.id&&e.onData===r.data)return s.splice(n,1),!0}),this},emit(e,r,s={}){let n,i;e instanceof t?(i=e,e=e.type):i=new t(e,this),0==s.bubble&&(i.bubble=!1),i.currentTarget=this,n=P(this,e);let a=0;if(Array.from(n).some((e,t)=>{if(i.cancel)return!0;let s=[i];!l(e.onData)&&(i.data=e.onData),!l(e.eventId)&&(i.eventId=e.eventId),!l(e.one)&&(i.one=e.one),!l(r)&&s.push(r),e.callback.apply(this,s),delete i.data,delete i.eventId,delete i.one,e.one&&(n.splice(t-a,1),a++)}),i.bubble&&!i.cancel){let{parent:e}=this;e&&(i.keys.unshift(this.hostkey),e.emit(i,r))}return this},seek(e){let t,r=[],s=e.match(/(^[^\[\]])\[.+\]/);s&&s.length>=2&&(t=s[1]);e.match(/\[.+?\]/g).forEach(e=>{let t=(e=e.replace(/\[|\]/g,"")).split(/(=|\*=|:=|~=)/),s=t[0];switch(t.length){case 3:s?r.push({type:"keyValue",k:s,eqType:t[1],v:t[2]}):r.push({type:"hasValue",eqType:t[1],v:t[2]});break;case 1:r.push({type:"hasKey",k:s})}});let n;return r.forEach((e,t)=>{let r=e.k,s=e.v,i=e.type,l=e.eqType;switch(t){case 0:n=j(this,e);break;default:n=n.filter(e=>I(r,s,i,l,e)?e:void 0)}}),t&&(n=n.filter(e=>e.hostkey==t?e:void 0)),n},entrend(e){let t=this;switch(e.keys.forEach(e=>{t=t[e]}),e.genre){case"arrayMethod":if(this[w].includes(e.modifyId))return this;_(this,e.modifyId),t._entrendModifyId=e.modifyId,t[e.methodName](...e.args);break;case"delete":delete t[e.key];break;default:t[e.key]=e.value}return this},watch(e,t){let r=i(e);/function/.test(r)&&(t=e,e="_");let s=this[b].$;if(!s){s=this[b].$={timer:0,modifys:[]};let e;this.on("update",e=(e=>{let{trend:t}=e;s.modifys.push(t),clearTimeout(s.timer),s.timer=setTimeout(()=>{let e=Array.from(s.modifys);s.modifys.length=0,Object.keys(this[b]).forEach(t=>{let r=this[b][t];switch(t){case"$":break;case"_":r.arr.forEach(t=>{t({type:"watch",modifys:e})});break;default:let s=this.seek(t),{oldVals:n}=r,i=1;s.length!=n.length&&(i=0),i&&s.some((e,t)=>{if(n[t]!=e)return i=0,!0}),i||(r.arr.forEach(e=>{e({type:"watch",expr:t,old:n,val:s})}),n=s)}})},0)}))}let n=this[b][e]||(this[b][e]={arr:[]});if(n.arr.push(t),"_"!=e){let r=this.seek(e);t({val:r}),n.oldVals=r}return this},unwatch(e,t){let r=i(e);/function/.test(r)&&(t=e,e="_");let s=this[b][e];if(s){let e=s.arr.indexOf(t);e>-1&&s.arr.splice(e,1)}return this},sync(e,t){let r,s;switch(i(t)){case"string":this.watch(r=(r=>{r.modifys.forEach(r=>{(l(r.keys[0])?r.key:r.keys[0])==t&&e.entrend(r)})})),e.watch(s=(e=>{e.modifys.forEach(e=>{(l(e.keys[0])?e.key:e.keys[0])==t&&this.entrend(e)})}));break;case"array":this.watch(r=(r=>{r.modifys.forEach(r=>{let s=l(r.keys[0])?r.key:r.keys[0];t.includes(s)&&e.entrend(r)})})),e.watch(s=(e=>{e.modifys.forEach(e=>{let r=l(e.keys[0])?e.key:e.keys[0];t.includes(r)&&this.entrend(e)})}));break;case"object":let n={};Object.keys(t).forEach(e=>{n[t[e]]=e}),this.watch(r=(r=>{r.modifys.forEach(r=>{let s=(r=y(r)).keys[0];s=l(s)?r.key:s,t.hasOwnProperty(s)&&(l(r.keys[0])?r.key=t[s]:r.keys[0]=t[s],e.entrend(r))})})),e.watch(r=(e=>{e.modifys.forEach(e=>{let t=(e=y(e)).keys[0];t=l(t)?e.key:t,n.hasOwnProperty(t)&&(l(e.keys[0])?e.key=n[t]:e.keys[0]=n[t],this.entrend(e))})}));break;default:this.watch(r=(t=>{t.modifys.forEach(t=>{e.entrend(t)})})),e.watch(s=(e=>{e.modifys.forEach(e=>{this.entrend(e)})}))}return this[v].push({opp:e,oppWatchFunc:s,watchFunc:r}),this},unsync(e){let t=this[v].findIndex(t=>t.opp==e);if(t>-1){let e=this[v][t];this.unwatch(e.watchFunc),e.opp.unwatch(e.oppWatchFunc),this[v].splice(t,1)}else console.warn("not found => ",e);return this},removeByKey(e){/\D/.test(e)?delete this[e]:this.splice(parseInt(e),1)},remove(e){if(l(e)){let{parent:e}=this;e.removeByKey(this.hostkey)}else if(E(e))this.removeByKey(e.hostkey);else{let t=this.indexOf(e);t>-1&&this.removeByKey(t)}},clone(){return O(this.object)},add(e){!this.includes(e)&&this.push(e)},reset(e){let t=Object.keys(e);return Object.keys(this).forEach(e=>{t.includes(e)||"length"===e||delete this[e]}),u(this,e),this}}),c(A,{object:{get(){let e={};return Object.keys(this).forEach(t=>{let r=this[t];E(r)?e[t]=r.object:e[t]=r}),e}},string:{get(){return JSON.stringify(this.object)}},root:{get(){let e=this;for(;e.parent;)e=e.parent;return e}}});const C=/^_.+|^parent$|^hostkey$|^status$|^length$/;let S={set(e,r,s,n){if(C.test(r))return Reflect.set(e,r,s,n);let i=s;E(s)?s.parent==n?s.hostkey=r:"root"==s.status&&(s.status="binding",s.parent=n,s.hostkey=r):i=O(s,{parent:n,hostkey:r});let l,a=e[r];if(e[k])l=Reflect.set(e,r,i,n);else{if(a===i)return!0;if(E(a)&&E(i)&&a.string===i.string)return!0;let h,o=new t("update",n);e.hasOwnProperty(r)||(h=1),o.modify={genre:h?"set":"change",key:r,value:s,oldVal:a},l=Reflect.set(e,r,i,n),n.emit(o)}return l},deleteProperty(e,r){if(C.test(r))return Reflect.deleteProperty(e,r);if(!e.hasOwnProperty(r))return!0;let s;e.parent?s=e.parent[e.hostkey]:(Object.values(e).some(e=>{if(E(e))return s=e.parent,!0}),s||(s=new Proxy(e,S)));let n=e[r],i=Reflect.deleteProperty(e,r),l=new t("update",s);return l.modify={genre:"delete",key:r,oldVal:n},s.emit(l),i}},M={get(e,t,r){if(/\D/.test(t))return Reflect.get(e,t,r);{let e=r.ele.children[t];return e&&p(e)}},set(e,t,r,s){if(console.log(`setting ${t}!`),/\D/.test(t))return Reflect.set(e,t,r,s);{r=m(r);let e=s[t],{parentElement:n}=e.ele;return n.insertBefore(r.ele,e.ele),n.removeChild(e.ele),!0}},deleteProperty:(e,t)=>(console.log(`delete ${t}`),Reflect.defineProperty(e,t))},q=function(e){c(this,{[g]:{value:{}},[h]:{value:{}},tag:{enumerable:!0,value:e.tagName.toLowerCase()}})};const N=(e,t)=>{let r=e[g][t];if(r&&!r.length){let r=e[h][t];e.ele.removeEventListener(t,r),delete e[h][t]}};let L=q.prototype=Object.create(A);d(L,{on(...e){let r=e[0];if(!this[h][r]){let e;this.ele.addEventListener(r,e=(e=>{e.stopImmediatePropagation();let s=p(e.target),n=new t(r,s),i=s;for(;i.ele!==this.ele;)n.keys.unshift(i.hostkey),i=i.parent;this.emit(n)})),this[h][r]=e}return A.on.apply(this,e)},one(...e){let t=e[0],r=A.one.apply(this,e);return N(this,t),r},off(...e){let t=e[0],r=A.off.apply(this,e);return N(this,t),r},que(e){return V.que(e,this.ele)}}),c(L,{hostkey:{get(){return Array.from(this.ele.parentElement.children).indexOf(this.ele)}},parent:{get(){return p(this.ele.parentElement)}},next:{get(){return this.ele.nextElementSibling&&p(this.ele.nextElementSibling)}},prev:{get(){let{previousElementSibling:e}=this.ele;return e&&p(e)}},next:{get(){let{nextElementSibling:e}=this.ele;return e&&p(e)}},index:{get(){return this.parent.findIndex(e=>e.ele==this.ele)}},xvele:{get(){let{attributes:e}=this.ele;return e.hasOwnProperty("xv-ele")||e.hasOwnProperty("xv-render")}},rendered:{get(){return this.ele.attributes.hasOwnProperty("xv-render")}},class:{get(){return this.ele.classList}},string:{get(){return JSON.stringify(this.object)}},object:{get(){let e={tag:this.tag};if(!this.xvele){let t=this.ele.classList.value;t&&(e.class=t)}return this.forEach((t,r)=>{e[r]=t instanceof q?t.object:t}),e}},length:{get(){return this.ele.children.length}}}),["concat","every","filter","find","findIndex","forEach","map","slice","some"].forEach(e=>{let t=Array.prototype[e];t&&d(L,{[e](...e){return t.apply(Array.from(this.ele.children).map(e=>p(e)),e)}})});const D=(e,t,r,...s)=>{let n=[],{ele:i}=e,{children:l}=i;for(;r>0;){let e=l[t];n.push(m(e)),i.removeChild(e),r--}let a=l[t];return t>=0&&a?s.forEach(e=>{i.insertBefore(m(e).ele,a)}):s.forEach(e=>{i.appendChild(m(e).ele)}),n};d(L,{splice(...e){return D(this,...e)},unshift(...e){return D(this,0,0,...e),this.length},push(...e){return D(this,this.length,0,...e),this.length},shift(){return D(this,0,1,...args)},pop(){return D(this,this.length-1,1,...args)},sort(e){if(i(e).search("function")>-1){let{ele:t}=this,r=Array.from(t.children).map(e=>p(e)),s=Array.from(r);r.sort(e);let n=[];r.forEach(e=>{n.push(s.indexOf(e))}),r.forEach(e=>{t.appendChild(e.ele)})}else Array;return this},reverse(){let{ele:e}=this;return Array.from(e.children).reverse().forEach(t=>{e.appendChild(t)}),this},indexOf(e){return e instanceof q&&(e=e.ele),Array.from(this.ele.children).indexOf(e)},includes(e){return this.indexOf(e)>-1}}),d(L,{before(e){return D(this.parent,this.hostkey,0,e),this},after(e){return D(this.parent,this.hostkey+1,0,e),this},remove(){D(this.parent,this.hostkey,1)},empty(){return this.html="",this},parents(e){let t=[],r=this.parent;if(e)for(;r&&"html"!=r.tag;)f(r.ele,e)&&t.push(r),r=r.parent;else for(;r&&"html"!=r.tag;)t.push(r),r=r.parent;return t},siblings(e){let t=Array.from(this.ele.parentElement.children),r=t.indexOf(this.ele);return t.splice(r,1),e&&(t=t.filter(t=>{if(f(t,e))return!0})),t.map(e=>p(e))},que(e){return V.que(e,this.ele)}}),c(L,{display:{get(){return getComputedStyle(this.ele).display},set(e){this.ele.style.display=e}},text:{get(){return this.ele.textContent},set(e){this.ele.textContent=e}},html:{get(){return this.ele.innerHTML},set(e){this.ele.innerHTML=e}},style:{get(){return this.ele.style},set(e){let{style:t}=this,r=Array.from(t),s=Object.keys(e);r.forEach(e=>{s.includes(e)||(t[e]="")}),u(t,e)}},position:{get(){return{top:this.ele.offsetTop,left:this.ele.offsetLeft}}},offset:{get(){let e={top:0,left:0},t=this.ele;for(;t&&t!==document;)e.top+=t.offsetTop,e.left+=t.offsetLeft,t=t.offsetParent;return e}}});let V=e=>{if(e instanceof q)return e;let t=e;return"string"===i(e)&&-1===e.search("<")&&(t=document.querySelector(e)),m(t)};e.$=V,u(V,{fn:L,type:i,init:p,que:(e,t=document)=>Array.from(t.querySelectorAll(e)).map(e=>p(e)),xdata:O,register:e=>{u({tag:""},e)}})})(window);